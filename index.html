<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart UMB</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232C2A29%22/><text x=%2250%%22 y=%2255%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-weight=%22900%22 font-size=%2240%22 fill=%22%23FFCD00%22>UMB</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --umb-yellow: #FFCD00;
            --umb-dark: #2C2A29;
            --umb-gray: #747678;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--umb-yellow); color: var(--umb-dark); }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(44, 42, 41, 0.2); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--umb-dark); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Typing Indicator */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; background-color: var(--umb-dark); }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; color: #000; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.75em; color: #000; }
        .prose strong { color: #000; font-weight: 800; }
        .prose a { color: #000; text-decoration: underline; text-underline-offset: 4px; decoration-thickness: 2px; decoration-color: var(--umb-yellow); }
        .prose a:hover { background-color: var(--umb-yellow); }

        /* Buttons */
        .btn-primary { 
            background: var(--umb-dark); 
            color: #ffffff; 
            border: 2px solid var(--umb-dark); 
            font-weight: 600; 
        }
        .btn-primary:hover { 
            background: black; 
            border-color: black;
            color: var(--umb-yellow);
        }

        .bg-umb-mustard { background-color: var(--umb-yellow); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-umb-mustard">

    <!-- MAIN CHAT AREA (Single View) -->
    <div id="chat-section" class="flex-1 flex flex-col relative h-full">
        
        <!-- HEADER OVERLAY (Branding Top Left) -->
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-30 pointer-events-none">
            
            <!-- Branding (Left) - Double Click for Admin -->
            <div class="flex items-center gap-3 pointer-events-auto cursor-pointer group" 
                 ondblclick="checkAdminAccess()"
                 title="Smart UMB">
                <div class="w-12 h-12 bg-umb-dark rounded-xl flex items-center justify-center text-umb-yellow font-extrabold text-sm border-2 border-umb-dark shadow-sm group-hover:shadow-lg transition-all">
                    UMB
                </div>
                <div>
                    <h1 class="font-extrabold text-lg text-umb-dark leading-tight tracking-tight">Smart UMB</h1>
                    <p class="text-[10px] font-bold text-umb-dark/60 uppercase tracking-widest">Your virtual banking assistant</p>
                </div>
            </div>
        </div>

        <!-- Chat Box -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 custom-scroll scroll-smooth pt-28">
            <div class="max-w-2xl mx-auto space-y-8 pb-4">
                
                <!-- Welcome Message -->
                <div class="text-center space-y-3 mb-8 anim-enter">
                    <h2 class="text-3xl font-extrabold text-umb-dark tracking-tight drop-shadow-sm">Hello, I am SMART UMB</h2>
                    <p class="text-umb-dark/80 text-base font-bold">How can we help you today?</p>
                </div>

                <!-- Message Container -->
                <div id="messages-container" class="space-y-6"></div>

            </div>
        </div>

        <!-- Input Area (Floating) -->
        <div class="p-6 z-20">
            <div class="max-w-2xl mx-auto relative">
                <form onsubmit="event.preventDefault(); sendMessage();" class="relative group">
                    <input type="text" id="user-input" 
                        class="w-full bg-white text-umb-dark border-none rounded-2xl px-6 py-4 pr-14 focus:ring-4 focus:ring-umb-dark/20 outline-none text-base placeholder-gray-400 font-medium text-center shadow-lg transition-all"
                        placeholder="Type your question..." autocomplete="off">
                    
                    <button type="submit" 
                        class="absolute right-3 top-3 bottom-3 w-10 bg-umb-dark text-umb-yellow rounded-xl flex items-center justify-center hover:bg-black transition-all shadow-md transform hover:scale-105">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL (Overlay) -->
    <div id="admin-dashboard-modal" class="hidden fixed inset-0 bg-umb-dark/95 z-40 flex flex-col backdrop-blur-sm transition-opacity p-4 md:p-8">
        
        <div class="bg-white rounded-2xl shadow-2xl flex-1 flex flex-col overflow-hidden max-w-6xl mx-auto w-full border-4 border-umb-yellow">
            <!-- Admin Header -->
            <header class="h-16 border-b border-gray-100 flex items-center justify-between px-6 bg-gray-50/50">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-8 bg-umb-yellow rounded-full"></div>
                    <h2 class="text-lg font-bold text-umb-dark">Knowledge Base</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500 text-sm font-bold transition px-3">Log Out</button>
                    <button onclick="closeAdminDashboard()" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </header>

            <!-- Admin Content -->
            <div class="flex-1 overflow-y-auto p-6 custom-scroll bg-gray-50">
                <div class="flex justify-between items-center mb-6">
                    <div class="relative flex-1 max-w-md">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="kb-search" onkeyup="filterKB()" placeholder="Search entries..." 
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-umb-yellow focus:ring-1 focus:ring-umb-yellow outline-none transition">
                    </div>
                    <button onclick="openEditor()" class="btn-primary px-5 py-3 rounded-xl shadow-lg transition flex items-center gap-2 ml-4">
                        <i class="fas fa-plus"></i> Add New
                    </button>
                </div>

                <!-- Grid -->
                <div id="kb-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-10">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS (Login & Edit) -->

    <!-- Login Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-umb-dark/95 z-50 flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm border-2 border-umb-yellow text-center">
            <div class="w-12 h-12 bg-umb-dark rounded-full flex items-center justify-center text-umb-yellow text-xl mx-auto mb-4 border-2 border-umb-yellow">
                <i class="fas fa-lock"></i>
            </div>
            <h3 class="text-xl font-extrabold text-umb-dark mb-1" id="auth-title">Admin Access</h3>
            <p class="text-gray-400 text-xs mb-6 font-bold uppercase tracking-wider" id="auth-subtitle">Secure Login</p>
            
            <form onsubmit="event.preventDefault(); handleAuth();" class="space-y-4">
                <input type="text" id="auth-user" required placeholder="Username" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-umb-yellow outline-none transition font-medium text-center text-umb-dark">
                <input type="password" id="auth-pass" required placeholder="Password" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-umb-yellow outline-none transition font-medium text-center text-umb-dark">
                
                <button type="submit" id="auth-btn" class="btn-primary w-full py-3.5 rounded-xl transition shadow-lg">Unlock</button>
                
                <div class="flex justify-between items-center mt-4 px-1">
                    <button type="button" id="auth-reset-btn" onclick="resetAuth()" class="text-[10px] text-red-400 hover:text-red-600 font-bold hidden uppercase tracking-wide">Reset Account</button>
                    <button type="button" onclick="closeAuth()" class="text-[10px] text-gray-400 hover:text-umb-dark font-bold ml-auto uppercase tracking-wide">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-umb-dark" id="editor-title">Edit</h3>
                <button onclick="closeEditor()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:text-black transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-8 overflow-y-auto custom-scroll">
                <form id="editor-form" onsubmit="event.preventDefault(); saveEntry();" class="space-y-5">
                    <input type="hidden" id="entry-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Category</label>
                            <input type="text" id="entry-category" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-umb-yellow outline-none font-medium">
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Keywords</label>
                             <input type="text" id="entry-keywords" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-umb-yellow outline-none font-medium">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Answer</label>
                        <textarea id="entry-answer" rows="8" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-umb-yellow outline-none leading-relaxed font-medium"></textarea>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-between">
                <button id="delete-btn" onclick="deleteEntry()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold text-sm hidden">Delete</button>
                <div class="flex gap-3 ml-auto">
                    <button type="button" onclick="closeEditor()" class="px-5 py-2.5 rounded-xl border border-gray-200 font-bold text-gray-500 hover:bg-white transition">Cancel</button>
                    <button onclick="document.getElementById('editor-form').requestSubmit()" class="btn-primary px-6 py-2.5 rounded-xl shadow-lg transition">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const apiKey = ""; // Provided by environment
        const chatBox = document.getElementById('chat-box');
        const msgContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        
        // --- DATA ---
        const defaultData = [
            { id: 1, category: 'General', keywords: ['history', 'founded', 'about'], answer: "Universal Merchant Bank (UMB) opened its doors on March 15, 1972. We are a leading indigenous Ghanaian bank, formerly known as 'Merchant Bank'. We have a rich history of advising on major events like the merger of Ashanti Goldfields and Anglogold." },
            { id: 2, category: 'Leadership', keywords: ['ceo', 'manager', 'leadership', 'boss'], answer: "As of late 2024, **Mr. Felix Apau Awuku** has been appointed as the Acting CEO of UMB Bank, following Bank of Ghana approval." },
            { id: 3, category: 'Accounts', keywords: ['open', 'account', 'requirements'], answer: "To open a personal account: Valid Ghana Card, Account opening form, 2 passport photos, Proof of address (Utility bill/GPS). Visit any branch or use the SpeedApp." },
            { id: 4, category: 'Digital', keywords: ['speedapp', 'mobile app'], answer: "The UMB SpeedApp is your bank in your pocket. Features: Instant transfers (Momo/Bank), Bill Payments, Airtime Top-up, Loan Requests." },
            { id: 5, category: 'Loans', keywords: ['loan', 'soda', 'salary advance'], answer: "We offer: Salary Overdraft (SODA), Personal Loans, SME Loans, and Auto Loans. Visit a branch to apply." },
            { id: 6, category: 'Support', keywords: ['contact', 'phone', 'help'], answer: "Available 24/7. Toll-Free: 0800-100880. Direct: +233 302 666 331. Email: info@myumbbank.com." },
            { id: 7, category: 'Vision', keywords: ['vision', 'mission'], answer: "**Vision:** UMB aspires to be positioned as a leading Ghanaian Bank and a leader in innovative banking solutions. \n**Mission:** To lead, create and professionally provide a wide range of innovative and superior banking services that guarantee returns exceeding stakeholders' expectations." },
            { id: 8, category: 'Private Banking', keywords: ['private banking', 'wealth'], answer: "UMB Private Banking offers: Prominence Lounge access, Relationship Managers, and bespoke investment solutions." },
            { id: 9, category: 'Locations', keywords: ['branch', 'location'], answer: "Over 35 branches nationwide including SSNIT Emporium (HQ), Accra Main, Osu, Tema, Kumasi Main, and Takoradi." }
        ];

        let db = JSON.parse(localStorage.getItem('umb_kb')) || defaultData;
        let isAdmin = false;
        let currentEditId = null;

        // --- AUTH LOGIC ---
        function checkAdminAccess() {
            if (isAdmin) {
                openAdminDashboard();
                return;
            }

            const storedCreds = localStorage.getItem('umb_admin_creds');
            const modal = document.getElementById('auth-modal');
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const btn = document.getElementById('auth-btn');
            const resetBtn = document.getElementById('auth-reset-btn');

            modal.classList.remove('hidden');

            if (!storedCreds) {
                title.innerText = "Setup Admin";
                subtitle.innerText = "Create credentials";
                btn.innerText = "Create Account";
                modal.dataset.mode = "register";
                if(resetBtn) resetBtn.classList.add('hidden');
            } else {
                title.innerText = "Admin Login";
                subtitle.innerText = "Enter credentials";
                btn.innerText = "Login";
                modal.dataset.mode = "login";
                if(resetBtn) resetBtn.classList.remove('hidden');
            }
        }

        function handleAuth() {
            const user = document.getElementById('auth-user').value;
            const pass = document.getElementById('auth-pass').value;
            const modal = document.getElementById('auth-modal');
            const mode = modal.dataset.mode;

            if (!user || !pass) { alert("Fields required"); return; }

            if (mode === 'register') {
                localStorage.setItem('umb_admin_creds', JSON.stringify({ user, pass }));
                alert("Account created!");
                isAdmin = true;
                closeAuth();
                openAdminDashboard();
            } else {
                const stored = JSON.parse(localStorage.getItem('umb_admin_creds'));
                if (user === stored.user && pass === stored.pass) {
                    isAdmin = true;
                    closeAuth();
                    openAdminDashboard();
                } else {
                    alert("Invalid credentials.");
                }
            }
        }

        function resetAuth() {
            if(confirm("Are you sure? This will delete the current admin account.")) {
                localStorage.removeItem('umb_admin_creds');
                checkAdminAccess();
            }
        }

        function closeAuth() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-user').value = "";
            document.getElementById('auth-pass').value = "";
        }

        function handleLogout() {
            isAdmin = false;
            closeAdminDashboard();
            alert("Logged out.");
        }

        // --- DASHBOARD LOGIC ---
        function openAdminDashboard() {
            document.getElementById('admin-dashboard-modal').classList.remove('hidden');
            renderKBGrid();
        }

        function closeAdminDashboard() {
            document.getElementById('admin-dashboard-modal').classList.add('hidden');
        }

        // --- CRUD ---
        function saveToStorage() { localStorage.setItem('umb_kb', JSON.stringify(db)); }
        
        function filterKB() {
            const term = document.getElementById('kb-search').value.toLowerCase();
            renderKBGrid(term);
        }

        function renderKBGrid(filterTerm = '') {
            const grid = document.getElementById('kb-grid');
            grid.innerHTML = '';
            const filtered = db.filter(item => 
                item.keywords.join(' ').includes(filterTerm) || 
                item.category.toLowerCase().includes(filterTerm) ||
                item.answer.toLowerCase().includes(filterTerm)
            );

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl border border-gray-100 hover:border-umb-yellow shadow-sm hover:shadow-md transition cursor-pointer flex flex-col h-full group";
                card.onclick = () => openEditor(item.id);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-gray-100 text-gray-600 text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded-md">
                            ${item.category}
                        </span>
                        <i class="fas fa-pencil-alt text-gray-300 group-hover:text-umb-dark transition"></i>
                    </div>
                    <h4 class="font-bold text-umb-dark mb-2 truncate">${item.keywords[0]}</h4>
                    <p class="text-xs text-gray-500 line-clamp-3 mb-4 flex-1 leading-relaxed">${item.answer}</p>
                    <div class="text-[10px] text-gray-300 font-mono mt-auto pt-3 border-t border-gray-50">ID: ${item.id}</div>
                `;
                grid.appendChild(card);
            });
        }

        function openEditor(id = null) {
            currentEditId = id;
            const modal = document.getElementById('editor-modal');
            const deleteBtn = document.getElementById('delete-btn');
            const title = document.getElementById('editor-title');
            
            if (id) {
                const item = db.find(x => x.id === id);
                title.innerText = "Edit Entry";
                document.getElementById('entry-category').value = item.category;
                document.getElementById('entry-keywords').value = item.keywords.join(', ');
                document.getElementById('entry-answer').value = item.answer;
                deleteBtn.classList.remove('hidden');
            } else {
                title.innerText = "New Entry";
                document.getElementById('editor-form').reset();
                deleteBtn.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeEditor() { document.getElementById('editor-modal').classList.add('hidden'); }

        function saveEntry() {
            const category = document.getElementById('entry-category').value;
            const keywordStr = document.getElementById('entry-keywords').value;
            const answer = document.getElementById('entry-answer').value;
            const keywords = keywordStr.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);

            if (currentEditId) {
                const index = db.findIndex(x => x.id === currentEditId);
                if (index !== -1) db[index] = { id: currentEditId, category, keywords, answer };
            } else {
                db.unshift({ id: Date.now(), category, keywords, answer });
            }
            saveToStorage();
            closeEditor();
            renderKBGrid();
        }

        function deleteEntry() {
            if(confirm('Delete this entry?')) {
                db = db.filter(x => x.id !== currentEditId);
                saveToStorage();
                closeEditor();
                renderKBGrid();
            }
        }

        // --- CHAT ---
        function appendMessage(sender, text, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} anim-enter`;
            
            if (isUser) {
                // User: Dark Grey bubble, White text
                div.innerHTML = `
                    <div class="bg-umb-dark text-white px-5 py-3 rounded-2xl rounded-br-none max-w-[85%] text-sm font-medium shadow-md">
                        ${text}
                    </div>
                `;
            } else {
                // Bot: White bubble, Black text
                const parsed = marked.parse(text);
                div.innerHTML = `
                    <div class="flex items-start max-w-full md:max-w-[85%]">
                        <div class="w-8 h-8 bg-umb-dark rounded-full flex items-center justify-center text-umb-yellow text-[10px] font-bold mr-3 flex-shrink-0 mt-1 shadow-sm border-2 border-white">
                            UMB
                        </div>
                        <div class="bg-white text-black px-5 py-4 rounded-2xl rounded-tl-none text-sm leading-relaxed prose prose-sm shadow-md">
                            ${parsed}
                        </div>
                    </div>
                `;
            }
            msgContainer.appendChild(div);
            const chatScroll = document.getElementById('chat-box');
            chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' });
        }

        function showTyping() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex justify-start anim-enter';
            div.innerHTML = `
                <div class="flex items-center ml-12">
                     <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-none flex space-x-1 shadow-md">
                        <div class="w-1.5 h-1.5 bg-umb-dark rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-umb-dark rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-umb-dark rounded-full typing-dot"></div>
                     </div>
                </div>`;
            msgContainer.appendChild(div);
            const chatScroll = document.getElementById('chat-box');
            chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' });
        }

        function removeTyping() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function getGeminiResponse(userQuery) {
            const knowledgeString = JSON.stringify(db.map(x => ({ keywords: x.keywords, answer: x.answer })));
            const systemPrompt = `You are "Smart UMB", the official AI assistant for Universal Merchant Bank (Ghana). 
            
            KNOWLEDGE BASE (Priority 1):
            ${knowledgeString}

            INSTRUCTIONS:
            1. **HIERARCHY:** Check the Knowledge Base first. If the answer is there, USE IT verbatim.
            2. If not in the Knowledge Base, use Google Search to find answers on **https://www.myumbbank.com/**.
            3. Draft letters professionally if asked.
            4. Be polite, concise, and helpful.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ google_search: {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API failed", error);
                return null;
            }
        }

        function getLocalFallback(userQuery) {
            const cleanQuery = userQuery.toLowerCase();
            let bestMatch = null;
            let maxScore = 0;
            db.forEach(entry => {
                let score = 0;
                entry.keywords.forEach(k => { if (cleanQuery.includes(k)) score++; });
                if (score > maxScore) { maxScore = score; bestMatch = entry; }
            });
            return maxScore > 0 ? bestMatch.answer : "I can't connect to my AI brain right now, but I'm here to help. Please contact our support team at 0800-100880.";
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // SECRET ADMIN TRIGGER: /admin
            if (text.toLowerCase() === '/admin') {
                userInput.value = '';
                checkAdminAccess();
                return;
            }

            appendMessage('User', text, true);
            userInput.value = '';
            showTyping();
            
            let response = await getGeminiResponse(text);
            if (!response) response = getLocalFallback(text);

            removeTyping();
            appendMessage('Smart UMB', response, false);
        }
    </script>
</body>
</html>